# Umbrella Signature Server

Сервис цифровых подписей и лицензирования, обеспечивающий выпуск, проверку и активацию лицензий на основе RSA-подписей.

---

## Развертывание проекта

### 1. Копирование конфигурации

```bash
make env
```

2. Инициализация проекта (сборка и запуск)

```bash
make build
```

3. Управление окружением

```bash
make up       # Запустить контейнеры
make down     # Остановить контейнеры
make restart  # Перезапустить контейнеры
make clean    # Удалить контейнеры и образы
make clean-volumes # Удалить контейнеры, образы и тома
```

---

## Разработка и тестирование

### Проверка кода на ошибки

```bash
make lint
```

### Автоматическое исправление стиля

```bash
make fix
```

---

## API методы

### POST /v1/license/issue

Выпускает новую лицензию с цифровой подписью RSA.

-   Request:

```json
{
    "fingerprint": "optional-device-id",
    "duration_hours": 24
}
```

> Если fingerprint не указан, сервер автоматически создаёт анонимный идентификатор.

-   Response:

```json
{
    "license": "base64-encoded-license"
}
```

> Если по fingerprint уже существует активированная и не истекшая лицензия — новая не создаётся.
> В остальных случаях сервер выпускает новую лицензию, подписывает и сохраняет её.

-   Коды ответа:

```text
Код Описание
200 Лицензия успешно создана
400 Ошибка формата запроса
409 Лицензия уже активирована и не истекла
500 Внутренняя ошибка при создании лицензии
```

### POST /v1/license/verify

Проверяет подлинность и активирует лицензию при первом обращении.
Используется клиентами для подтверждения, что лицензия действительна и подписана сервером.

-   Request:

```json
{
    "secret_payload": "base64-encoded-json-with-license-and-fingerprint"
}
```

Пример содержимого secret_payload (в Base64):

```json
{
    "license": "base64-encoded-license",
    "fingerprint": "user-device-123"
}
```

-   Response:

```text
"base64-encoded-rsa-signature" // подпись JSON { "valid": true/false }
```

Подпись (RSA-SHA256) создаётся от JSON-ответа { "valid": true }.
Клиент должен декодировать Base64, проверить подпись с помощью публичного ключа и убедиться, что поле valid = true.

> Если лицензия впервые проверяется — она активируется.
> Если срок действия лицензии истёк — сервер возвращает ошибку 401 Unauthorized.
> Если лицензия не найдена — возвращается 404 Not Found.

-   Коды ответа:

```text
Код Описание
200 Проверка выполнена успешно
400 Ошибка формата или валидации данных
401 Срок действия лицензии истёк
404 Лицензия не найдена
500 Ошибка верификации или сохранения данных
```

---

### GET /v1/keypair/public.pem

Возвращает публичный RSA-ключ, необходимый клиенту для проверки подписи.

-   Response:

```text
-----BEGIN PUBLIC KEY-----
...
-----END PUBLIC KEY-----
```

-   Коды ответа:

```text
Код Описание
200 Ключ успешно возвращён
500 Ошибка при чтении ключа
```

---

## Ключи RSA

-   При первом запуске сервис автоматически создаёт ключи.
-   Путь и параметры задаются в .env:

```text
SIGNATURE_PRIVATE_KEY_PATH=/app/keys/private.pem
SIGNATURE_PUBLIC_KEY_PATH=/app/keys/public.pem
SIGNATURE_PRIVATE_KEY_BITS=2048
```

---

## Логика лицензирования

1. Fingerprint — уникальный идентификатор устройства или пользователя.
   Используется как ключ для поиска лицензии.
2. Лицензия имеет статус Activated и временные границы IssuedAt / ExpiresAt.
3. Перевыпуск невозможен, если текущая лицензия активирована и не истекла.
4. secret_payload служит защищённой упаковкой лицензии и отпечатка.
5. Ответ сервера содержит RSA-подпись JSON, которую клиент проверяет публичным ключом.
6. Система устойчива к повторным запросам — повторная активация невозможна.
